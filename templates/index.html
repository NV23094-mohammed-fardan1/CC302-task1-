{% extends "base.html" %}

{% block title %}Dashboard - Task Manager Pro{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1><i class="bi bi-grid-fill"></i> Dashboard</h1>
    <p>Welcome back! Here's your task overview</p>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-card-title">Total Tasks</div>
            </div>
            <div class="stat-card-icon stat-primary">
                <i class="bi bi-list-task"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.total }}</div>
        <div class="stat-card-label">All time tasks</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-card-title">Completed</div>
            </div>
            <div class="stat-card-icon stat-success">
                <i class="bi bi-check-circle-fill"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.completed }}</div>
        <div class="stat-card-label">{{ stats.completion_rate }}% completion rate</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-card-title">Pending</div>
            </div>
            <div class="stat-card-icon stat-warning">
                <i class="bi bi-clock-fill"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.pending }}</div>
        <div class="stat-card-label">Tasks in progress</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-card-title">Overdue</div>
            </div>
            <div class="stat-card-icon stat-danger">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.overdue }}</div>
        <div class="stat-card-label">Need attention</div>
    </div>
</div>

<!-- Priority & Analytics -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title"><i class="bi bi-bar-chart-fill"></i> Priority Distribution</h3>
            </div>
            <canvas id="priorityChart" height="200"></canvas>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title"><i class="bi bi-graph-up"></i> Productivity (Last 7 Days)</h3>
            </div>
            <canvas id="productivityChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Add Task Form -->
<div class="chart-container mb-4">
    <div class="chart-header">
        <h3 class="chart-title"><i class="bi bi-plus-circle-fill"></i> Add New Task</h3>
    </div>
    
    <form action="{{ url_for('add') }}" method="POST">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label" for="task">Task Title *</label>
                <input type="text" name="task" id="task" class="form-control" placeholder="Enter task name" required>
            </div>
            
            <div class="col-md-6">
                <label class="form-label" for="category">Category *</label>
                <select name="category" id="category" class="form-select" required>
                    <option value="Work">Work</option>
                    <option value="Personal">Personal</option>
                    <option value="Study">Study</option>
                    <option value="Health">Health</option>
                    <option value="Finance">Finance</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="col-md-12">
                <label class="form-label" for="description">Description</label>
                <textarea name="description" id="description" class="form-control" rows="2" placeholder="Add task details (optional)"></textarea>
            </div>
            
            <div class="col-md-4">
                <label class="form-label" for="priority">Priority *</label>
                <select name="priority" id="priority" class="form-select" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label class="form-label" for="due_date">Due Date</label>
                <input type="date" name="due_date" id="due_date" class="form-control">
            </div>
            
            <div class="col-md-4">
                <label class="form-label" for="tags">Tags</label>
                <input type="text" name="tags" id="tags" class="form-control" placeholder="e.g., urgent, meeting">
            </div>
            
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Task
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Filters -->
<div class="filters-container">
    <form method="GET" action="{{ url_for('index') }}">
        <div class="filters-row">
            <div>
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Search tasks..." value="{{ current_filters.search }}">
            </div>
            
            <div>
                <label class="form-label">Category</label>
                <select name="category" class="form-select">
                    <option value="all" {{ 'selected' if current_filters.category == 'all' }}>All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {{ 'selected' if current_filters.category == category }}>{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="form-label">Priority</label>
                <select name="priority" class="form-select">
                    <option value="all" {{ 'selected' if current_filters.priority == 'all' }}>All Priorities</option>
                    <option value="High" {{ 'selected' if current_filters.priority == 'High' }}>High</option>
                    <option value="Medium" {{ 'selected' if current_filters.priority == 'Medium' }}>Medium</option>
                    <option value="Low" {{ 'selected' if current_filters.priority == 'Low' }}>Low</option>
                </select>
            </div>
            
            <div>
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="all" {{ 'selected' if current_filters.status == 'all' }}>All Tasks</option>
                    <option value="pending" {{ 'selected' if current_filters.status == 'pending' }}>Pending</option>
                    <option value="completed" {{ 'selected' if current_filters.status == 'completed' }}>Completed</option>
                    <option value="overdue" {{ 'selected' if current_filters.status == 'overdue' }}>Overdue</option>
                </select>
            </div>
        </div>
        
        <div class="mt-3">
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-funnel-fill"></i> Apply Filters
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm" style="background: var(--text-secondary);">
                <i class="bi bi-x-circle"></i> Clear Filters
            </a>
        </div>
    </form>
</div>

<!-- Tasks List -->
<div class="chart-header mb-3">
    <h3 class="chart-title"><i class="bi bi-list-ul"></i> Your Tasks ({{ todos|length }})</h3>
</div>

{% if todos %}
    {% for task in todos %}
    <div class="task-card {{ 'completed' if task.completed }}">
        <div class="task-card-priority priority-{{ task.priority.lower() }}"></div>
        
        <div class="task-card-header">
            <div style="flex: 1;">
                <h4 class="task-card-title">{{ task.task }}</h4>
                {% if task.description %}
                <p class="task-card-description">{{ task.description }}</p>
                {% endif %}
                
                <div class="task-card-meta">
                    <span class="task-badge badge-category">
                        <i class="bi bi-folder-fill"></i> {{ task.category }}
                    </span>
                    
                    <span class="task-badge badge-priority-{{ task.priority.lower() }}">
                        <i class="bi bi-flag-fill"></i> {{ task.priority }}
                    </span>
                    
                    {% if task.due_date %}
                        {% set today = None %}
                        {% set is_overdue = task.due_date < today and not task.completed %}
                        <span class="task-badge {{ 'badge-overdue' if is_overdue else 'badge-due' }}">
                            <i class="bi bi-calendar-event"></i> 
                            {% if is_overdue %}
                                Overdue: {{ task.due_date.strftime('%b %d, %Y') }}
                            {% else %}
                                Due: {{ task.due_date.strftime('%b %d, %Y') }}
                            {% endif %}
                        </span>
                    {% endif %}
                    
                    {% if task.tags %}
                    <span class="task-badge" style="background: rgba(139, 92, 246, 0.1); color: var(--secondary-color);">
                        <i class="bi bi-tag-fill"></i> {{ task.tags }}
                    </span>
                    {% endif %}
                    
                    <small style="color: var(--text-secondary);">
                        <i class="bi bi-clock"></i> Created {{ task.created_at.strftime('%b %d') }}
                    </small>
                </div>
            </div>
            
            <div class="task-card-actions">
                <a href="{{ url_for('complete', id=task.id) }}" class="btn btn-{{ 'secondary' if task.completed else 'success' }} btn-sm btn-icon" title="Mark as {{ 'pending' if task.completed else 'complete' }}">
                    <i class="bi bi-{{ 'arrow-counterclockwise' if task.completed else 'check2' }}"></i>
                </a>
                <a href="{{ url_for('edit', id=task.id) }}" class="btn btn-warning btn-sm btn-icon" title="Edit">
                    <i class="bi bi-pencil-fill"></i>
                </a>
                <a href="{{ url_for('delete', id=task.id) }}" class="btn btn-danger btn-sm btn-icon" onclick="return confirm('Are you sure you want to delete this task?')" title="Delete">
                    <i class="bi bi-trash-fill"></i>
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="bi bi-inbox"></i>
        </div>
        <h3 class="empty-state-title">No tasks found</h3>
        <p class="empty-state-text">
            {% if current_filters.search or current_filters.category != 'all' or current_filters.priority != 'all' or current_filters.status != 'all' %}
                No tasks match your current filters. Try adjusting your search criteria.
            {% else %}
                You don't have any tasks yet. Create your first task above!
            {% endif %}
        </p>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Priority Distribution Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'doughnut',
        data: {
            labels: ['High Priority', 'Medium Priority', 'Low Priority'],
            datasets: [{
                data: [{{ stats.high_priority }}, {{ stats.medium_priority }}, {{ stats.low_priority }}],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12,
                            family: 'Inter'
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
    
    // Productivity Chart
    const productivityCtx = document.getElementById('productivityChart').getContext('2d');
    new Chart(productivityCtx, {
        type: 'line',
        data: {
            labels: {{ productivity.days | tojson }},
            datasets: [{
                label: 'Completed Tasks',
                data: {{ productivity.counts | tojson }},
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11,
                            family: 'Inter'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 11,
                            family: 'Inter'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Set today's date as minimum for due date picker
    const dueDateInput = document.getElementById('due_date');
    const today = new Date().toISOString().split('T')[0];
    dueDateInput.setAttribute('min', today);
</script>
{% endblock %}